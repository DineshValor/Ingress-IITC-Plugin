/*
 *  Copyright (C) 2021 TheKey.Blue - All Rights Reserved
 *    * This file is part of TheKey.Blue and can not be copied and/or distributed without the express and written permission.
 */

// ==UserScript==
// @name            IITC plugin: TheKey
// @id              TheKey
// @category        Keys
// @version         0.0.17
// @namespace       https://github.com/jonatkins/ingress-intel-total-conversion
// @updateURL       https://thekey.blue/plugin/TheKey.meta.js
// @downloadURL     https://thekey.blue/plugin/TheKey.user.js
// @description     Integrates with TheKey.blue
// @include         https://intel.ingress.com/*
// @author          Esquilim
// @icon64          data:image/png;base64,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
// ==/UserScript==
function wrapper(e){(()=>{"use strict";var t={465:(e,t,n)=>{n.d(t,{Z:()=>a});var o=n(645),s=n.n(o)()((function(e){return e[1]}));s.push([e.id,"#TheKeyRESWUEExport{display:flex;flex-direction:column}#TheKeyRESWUEExport select{margin-bottom:1em;text-align:center}#TheKeyRESWUEExport #export{margin-left:auto;margin-right:auto;margin-top:1em}#TheKeyRESWUEExport #keycount{border:1px solid #ffce00;font-weight:bolder;margin:.4em;text-align:center}#TheKeyRESWUEExport .status{color:#ffce00;font-size:1.3em;font-weight:700;margin-left:auto;margin-right:auto;margin-top:1em}.menu-connected{color:green;font-weight:700}.menu-disconnected{color:red;font-weight:700}.menu-yellow{color:#ff0}.bold,.menu-yellow{font-weight:700}.has-key,.text-center{text-align:center}.has-key{color:green}.no-keys{color:red;text-align:center}.the-key-add-remove{display:block}.full-width{text-align:center;width:100%}.the-key-margin{margin-bottom:5px;margin-top:5px}",""]);const a=s},645:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=e(t);return t[2]?"@media ".concat(t[2]," {").concat(n,"}"):n})).join("")},t.i=function(e,n,o){"string"==typeof e&&(e=[[null,e,""]]);var s={};if(o)for(var a=0;a<this.length;a++){var i=this[a][0];null!=i&&(s[i]=!0)}for(var r=0;r<e.length;r++){var l=[].concat(e[r]);o&&s[l[0]]||(n&&(l[2]?l[2]="".concat(n," and ").concat(l[2]):l[2]=n),t.push(l))}},t}},577:(e,t,n)=>{n.r(t),n.d(t,{default:()=>v});var o=n(994),s=n.n(o),a=n(795),i=n.n(a),r=n(569),l=n.n(r),c=n(565),d=n.n(c),u=n(216),p=n.n(u),h=n(589),y=n.n(h),g=n(465),f={};f.styleTagTransform=y(),f.setAttributes=d(),f.insert=l().bind(null,"head"),f.domAPI=i(),f.insertStyleElement=p();s()(g.Z,f);const v=g.Z&&g.Z.locals?g.Z.locals:void 0},994:e=>{var t=[];function n(e){for(var n=-1,o=0;o<t.length;o++)if(t[o].identifier===e){n=o;break}return n}function o(e,o){for(var a={},i=[],r=0;r<e.length;r++){var l=e[r],c=o.base?l[0]+o.base:l[0],d=a[c]||0,u="".concat(c," ").concat(d);a[c]=d+1;var p=n(u),h={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==p)t[p].references++,t[p].updater(h);else{var y=s(h,o);o.byIndex=r,t.splice(r,0,{identifier:u,updater:y,references:1})}i.push(u)}return i}function s(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,s){var a=o(e=e||[],s=s||{});return function(e){e=e||[];for(var i=0;i<a.length;i++){var r=n(a[i]);t[r].references--}for(var l=o(e,s),c=0;c<a.length;c++){var d=n(a[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}a=l}}},569:e=>{var t={};e.exports=function(e,n){var o=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},216:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},565:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},795:e=>{e.exports=function(e){var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var s=void 0!==n.layer;s&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,s&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var a=n.sourceMap;a&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},589:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},n={};function o(e){var s=n[e];if(void 0!==s)return s.exports;var a=n[e]={id:e,exports:{}};return t[e](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};(()=>{o.d(s,{B:()=>h});const t=new class{constructor(){this.SERVER_VERSION="Unknown",this.SERVER_ENV="Unknown",this.SERVER_MIN_VERSION="0.0.17",this.SERVER_CONNECTED=!1}pingAuthentication(){return this.apiCall("GET","ping").then((e=>(this.SERVER_VERSION=e.version,this.SERVER_ENV=e.environment,this.SERVER_CONNECTED=!0,!0))).catch((()=>!1))}getAllUserKeys(){return this.apiCall("GET","key").then((e=>e.portals))}getUserCollections(){return this.apiCall("GET","collection").then((e=>e.collections))}getAllVisibleKeys(){return this.apiCall("GET","collection/keys").then((e=>e.portals))}getUserCapsules(){return this.apiCall("GET","capsule").then((e=>e.capsules))}updateSingleKey(e,t,n){return this.apiCall("POST","key/single",{portal:e,capsuleId:t,amount:n})}getCollectionKeys(e){return this.apiCall("GET",`collection/${e}/keys`).then((e=>e.portals))}sendAllKeys(e){return this.apiCall("POST","key",{inventory:e})}apiCall(e,t,n){const o=window.localStorage.getItem("theKey-token");if(!o)return Promise.reject(new Error("not authorized"));return fetch(`https://api.thekey.blue/v1/${t}`,{method:e,headers:new Headers({Accept:"application/json",Authorization:o,"Content-Type":"application/json; charset=utf-8"}),body:JSON.stringify(n)}).then((e=>(e.ok||e.json().then((t=>{throw new Error(t.error||e.statusText)})),e.json()))).then((e=>{if(!e.success)throw new Error(e.error);return e}))}isServerCompatible(){return this.versionCompare(this.SERVER_VERSION,this.SERVER_MIN_VERSION)>=0}versionCompare(e,t,n){const o=n&&n.lexicographical,s=n&&n.zeroExtend;let a=e.split("."),i=t.split(".");const r=e=>(o?/^\d+[A-Za-z]*$/:/^\d+$/).test(e);if(!a.every(r)||!i.every(r))return NaN;if(s){for(;a.length<i.length;)a.push("0");for(;i.length<a.length;)i.push("0")}o||(a=a.map(Number),i=i.map(Number));for(const[e,t]of a.entries()){if(i.length===e)return 1;if(t!==i[e])return t>i[e]?1:-1}return a.length!==i.length?-1:0}},n=()=>window.plugin.reswue2,a=()=>{var e;return null===(e=n())||void 0===e?void 0:e.operations.current()},i="--- All Users ---";class r{constructor(){this.shared=new Map,this.sharedRequested=new Map,this.dialog=this.createDialog(),this.fillDialog()}static register(){this.isPossible()&&(e=>{if("string"!=typeof e.name||"function"!=typeof e.action)throw new Error("registerAddon has wrong arguments");const t=n();t&&t.registerAddon&&n().registerAddon(e)})({name:"Import Keys (TheKey)",action:()=>new r})}static isPossible(){return(e=>{const t=n();return void 0!==t&&"function"==typeof t.checkVersion&&t.checkVersion(e)})("2.19.0")}createDialog(){const e=$("<div>",{id:"TheKeyRESWUEExport"}).append($("<select>",{id:"user",change:()=>this.updateCapsules()}),$("<select>",{id:"capsule",change:()=>this.onCapsuleChanged()}),$("<div>",{id:"keycount"}),$("<select>",{id:"mykeys",change:()=>this.onCapsuleChanged()}).append($("<option>",{text:"Set my keys",value:1}),$("<option>",{text:"Don't change my keys",value:0}),$("<option>",{text:"Add keys of agents not in the OP to my keys",value:2})),(e=>{const t=document.createElement("input");t.type="checkbox",e.id&&(t.id=e.id),e.click&&t.addEventListener("change",(t=>e.click(t.target))),void 0!==e.status&&(t.checked=e.status);const n=document.createElement("label"),o=document.createTextNode(e.text);return n.append(t,o),n})({id:"createPortals",text:"Create new portals for every key",click:()=>this.onCapsuleChanged()}),$("<button>",{id:"export",text:"Export",click:()=>this.onExport()}),$("<span>",{id:"exportProgress",text:"",class:"status"}).hide());return window.dialog({title:"TheKey RESWUE export",id:"TheKeyRESWUEExport",html:e})}fillDialog(){this.updateUsers(),$("#user",this.dialog).val(i),this.updateCapsules(),this.onCapsuleChanged()}updateUsers(){const e=new Set;h.userCollections.forEach((t=>{var n;return null===(n=t.members)||void 0===n?void 0:n.forEach((t=>e.add(t.user.agent_name)))}));const t=[...e.values()].sort(((e,t)=>e.toLocaleLowerCase().localeCompare(t.toLocaleLowerCase())));t.splice(0,0,i);const n=$("#user",this.dialog);n.empty(),t.forEach((e=>n.append($("<option>",{text:e}))))}updateCapsules(){const e=$("#user",this.dialog).val();this.updateCollections(e!==i?e:void 0)}updateCollections(e){let t=h.userCollections;e&&(t=t.filter((t=>{var n;return null===(n=t.members)||void 0===n?void 0:n.some((t=>t.user.agent_name===e))})));const n=t.map((e=>{var t;const n=null===(t=e.members)||void 0===t?void 0:t.find((e=>e.access.value=100));return n?{name:`${e.name} (${n.user.agent_name})`,id:e.id}:{name:e.name,id:e.id}}));n.sort(((e,t)=>e.name.toLocaleLowerCase().localeCompare(t.name.toLocaleLowerCase())));const o=$("#capsule",this.dialog);o.empty(),n.forEach((e=>o.append($("<option>",{text:e.name,value:e.id}))))}async getCapsule(e){const n=this.shared.get(e);if(n)return n;this.sharedRequested.has(e)||this.sharedRequested.set(e,t.getCollectionKeys(e));try{const t=await this.sharedRequested.get(e);this.sharedRequested.delete(e);const n=null==t?void 0:t.map((e=>{var t;const n={guid:e.guid,name:e.name,position:L.latLng(e.lat,e.lng),description:""},o=null===(t=e.keys)||void 0===t?void 0:t.map((e=>({name:e.user.agent_name,count:e.count})));return{portal:n,agents:o}}));return this.shared.set(e,n||[]),n}catch(e){return}}async onCapsuleChanged(){const e=parseInt($("#capsule",this.dialog).val());$("#keycount",this.dialog).text("(loading)"),$("#export",this.dialog).prop("disabled");const t=await this.getCapsule(e);this.updateKeyCount(t),$("#export",this.dialog).prop("disabled",!1)}updateKeyCount(e){if(!e)return void $("#keycount",this.dialog).text("no keys");const t=(e=this.filterKeysByOptions(e)).reduce(((e,t)=>e+t.agents.reduce(((e,t)=>e+t.count),0)),0),n=`${e.length} Portals with a total of ${t} Keys`;$("#keycount",this.dialog).text(n)}filterKeysByOptions(e){const t=a();if(!t)return e;$("#createPortals",this.dialog).is(":checked")||(e=e.filter((e=>void 0!==t.portals.get(e.portal.guid)))),e=this.createKeyCopyAndFilterAgents(t,e);const n=parseInt($("#mykeys",this.dialog).val()),o=t.agents.getNameOf(t.myAgentID);return 2===n&&e.forEach((e=>{const t=e.agents.filter((e=>""===e.name)).reduce(((e,t)=>e+t.count),0),n=e.agents.find((e=>e.name===o));n?n.count+=t:e.agents.push({name:o,count:t})})),e.forEach((e=>{e.agents=e.agents.filter((e=>""!==e.name))})),0===n&&e.forEach((e=>{e.agents=e.agents.filter((e=>e.name!==o))})),e=e.filter((e=>e.agents.length>0))}createKeyCopyAndFilterAgents(e,t){return t.map((t=>{const n=t.agents.map((t=>this.getRESWUEAgentID(e,t.name)?{name:t.name,count:t.count}:{name:"",count:t.count}));return{portal:t.portal,agents:n}}))}getRESWUEAgentID(e,t){var n;return null===(n=e.agents.getAgentByName(t))||void 0===n?void 0:n.id}async onExport(){const e=parseInt($("#capsule",this.dialog).val());let t=await this.getCapsule(e);if(!t)return;const n=a();if(!n)return void alert("No RESWUE operation active");if(!n.isOperator())return void alert("You're not an operator of this operation");$("#export",this.dialog).hide(),$("#exportProgress",this.dialog).show(),t=this.filterKeysByOptions(t),t.length>0&&($("#exportProgress",this.dialog).text("Creating portals"),await this.createPortals(n,t));const o=this.groupByAgent(n,t);this.filterOldKeycounts(n,o);for(const e of o.keys()){const t=o.get(e);$("#exportProgress",this.dialog).text(`Processing ${n.agents.getNameOf(e)}`);const s=[...t].map((([e,t])=>({portal:n.portals.get(e),quantity:t})));e===n.myAgentID?await n.updateKeys(s):await n.updateKeysOfOtherAgent(e,s)}$("#exportProgress",this.dialog).hide(),$("#export",this.dialog).show()}filterOldKeycounts(e,t){t.forEach(((t,n)=>{e.keys.getByAgent(n).forEach(((e,n)=>{const o=t.get(n);void 0!==o?o===e&&t.delete(n):t.set(n,0)}))}))}groupByAgent(e,t){const n=new Map;return t.forEach((t=>{t.agents.forEach((o=>{const s=this.getRESWUEAgentID(e,o.name)||e.myAgentID;n.has(s)||n.set(s,new Map);const a=n.get(s),i=a.get(t.portal.guid)||0;a.set(t.portal.guid,i+o.count)}))})),n}async createPortals(e,t){const n=t.filter((t=>!e.portals.get(t.portal.guid))).map((t=>e.portals.createNewPortal(t.portal.guid,t.portal.name,t.portal.position,e.getDefaultLayers())));return e.addPortals(n)}}class l{init(){$("#toolbox").append($("<a>",{text:"TheKey",id:"theKeyToolbar",click:()=>this.openMenu()}));const e=$("<div>",{class:"leaflet-bar leaflet-control"});e.append($("<a>").addClass("leaflet-bar-part").css("background-image",'url("https://thekey.blue/img/logo/logo-compressed.png")').css("background-size","20px").on("click",(()=>this.openMenu())),$("<a>").addClass("leaflet-bar-part").css("background-image",'url("https://i.imgur.com/UiEoYOR.png")').css("background-size","20px").on("click",(()=>h.updateAllLayers())));$(".leaflet-top.leaflet-left",window.map.getContainer()).append(e),this.initEvents()}openMenu(){let e=window.localStorage.getItem("theKey-token");null===e&&(e=""),dialog({id:"the-key-setup",title:"The Key",height:"auto",width:400,html:'<p class="text-center bold">Authentication</p><label for="theKeyToken">Access Token:</label>\n  <input class="full-width the-key-margin" type="password" id="theKeyToken" name="theKeyToken" value="'+e+'"><br><input class="full-width the-key-margin" type="button" id="theKeyLoginBtn" value="Login"><br><p class="text-center">Connection Status: <span class="the-key-connection-status"></span></p><hr><p class="text-center bold">Options</p><input type="button" id="theKeyUploadAllKeys" value="Sync Keys"><hr><p class="text-center bold">Version</p><div style="text-align: center; font-weight: bold"><a href="https://thekey.blue" target="_blank">thekey.blue</a></div><div><span style="text-align: center; font-weight: bold">Plugin version: </span>0.0.17</div><div><span style="text-align: center; font-weight: bold">Server version: </span>'+t.SERVER_VERSION+" ("+t.SERVER_ENV+")</div>"}),t.SERVER_CONNECTED?$(".the-key-connection-status").addClass("menu-connected").text("Connected"):$(".the-key-connection-status").addClass("menu-disconnected").text("Not Connected"),r.isPossible()&&$("#theKeyUploadAllKeys").after($("<input>",{type:"button",value:"RESWUE Export",click:()=>new r}).css("float","right"))}initEvents(){$("body").on("click","#theKeyLoginBtn",(async()=>{const e=$("#theKeyToken").val();if("string"==typeof e){if("cookie"===e)return void alert("Did somebody mention cookies? ðŸ˜ Please donate them too @HendrikTovenaar ASAP!");if("debug-dumpinventory"===e)return alert("DEBUG: Inventory dump activated"),void(h.keyDebug=!0);window.localStorage.setItem("theKey-token",e),await t.pingAuthentication()?($(".the-key-connection-status").removeClass("menu-disconnected").addClass("menu-connected").text("Connected"),alert("TheKey is now connected!"),h.updateAllLayers()):($(".the-key-connection-status").removeClass("menu-connected").addClass("menu-disconnected").text("Not Connected"),window.localStorage.removeItem("theKey-token"),alert("TheKey login failed, please check your key"))}})),$("body").on("click","#theKeyUploadAllKeys",(()=>{this.uploadAllKeys()}))}checkSubscription(e){const t=niantic_params.CURRENT_VERSION,n=JSON.stringify({v:t});return $.ajax({url:"/r/getHasActiveSubscription",type:"POST",data:n,context:{},dataType:"json",success:[t=>e(void 0,t)],error:[t=>e(t)],contentType:"application/json; charset=utf-8",beforeSend:e=>{e.setRequestHeader("accept","*/*"),e.setRequestHeader("X-CSRFToken",readCookie("csrftoken"))}})}uploadAllKeys(){const e=$("#theKeyUploadAllKeys");e.val("Uploading...").prop("disabled",!0),this.checkSubscription(((n,o)=>{o&&!0===o.result?window.postAjax("getInventory",{lastQueryTimestamp:0},(n=>{if(0===n.result.length)return e.val("Sync Keys").prop("disabled",!1),void alert("No inventory received from Niantic, you are rate-limited, try again in about an hour");h.keyDebug?alert(JSON.stringify(n.result)):t.sendAllKeys(n).then((()=>alert("Keys uploaded, check the website"))).catch((e=>alert("Failed to upload keys:"+e))).finally((()=>{e.val("Sync Keys").prop("disabled",!1)}))}),(t=>{e.val("Sync Keys").prop("disabled",!1),alert("Failed to obtain CORE subscription status")})):(e.val("Sync Keys").prop("disabled",!1),alert("It looks like you don't have Ingress CORE, you need a CORE subscription to sync your keys"))}))}}class c{init(){this.initEvents()}openMenu(){this.checkOwnedKeys(),this.checkSharedKeys()}checkOwnedKeys(){var e;const t=selectedPortal;let n=!1;const o=h.ownedKeys.find((e=>e.guid===t));void 0===o||(n=!0);let s="<hr><div class='bold text-center'>TheKey</div>",a="";if(n){let t=0;null===(e=null==o?void 0:o.keys)||void 0===e||e.forEach((e=>{t+=e.count,null===e.capsule?a+=`<span>Inventory: <b>${e.count}</b></span><br>`:a+=`<span>Capsule ${e.capsule.name}: <b>${e.count}</b></span><br>`})),s+=`<div class='text-center' title='${a}' id='the-key-owned-keys'>Owned Keys: <b>${t}</b></div>`}else s+="<div class='no-keys' id='the-key-owned-keys'>No owned keys</div>";s+="<a id='theKeyAddRemoveBtn' class='text-center the-key-add-remove'>[Add/Remove Keys]</a>",$("#resodetails").after(s)}checkSharedKeys(){var e;const t=selectedPortal;let n=!1;const o=h.sharedKeys.find((e=>e.guid===t));void 0===o||(n=!0);let s="",a="",i=0;n&&(null===(e=null==o?void 0:o.keys)||void 0===e||e.forEach((e=>{var t,n;if((null==e?void 0:e.user.agent_name.toLowerCase())===PLAYER.nickname.toLowerCase())return;i+=e.count;let o="";null===(t=e.capsule)||void 0===t||t.collections.forEach((e=>{o+=e.name+","})),o=o.replace(/,\s*$/,""),o=" ("+o+")",null!==e.capsule?a+="<span>"+(null==e?void 0:e.user.agent_name)+" capsule "+(null===(n=e.capsule)||void 0===n?void 0:n.name)+o+": <b>"+e.count+"</b></span><br>":a+=e.count+" keys on "+e.user.agent_name+" inventory<br>"}))),n&&i>0&&(s+="<div class='text-center' title='"+a+"'>Shared keys: <b>"+i+"</b></div>"),$("#the-key-owned-keys").after(s)}initEvents(){window.addHook("portalDetailsUpdated",(()=>{h.portalDetailMenu.openMenu()}))}}class d{init(){this.initEvents()}async openMenu(){await h.updateUserCapsules();const e=selectedPortal&&window.portals[selectedPortal];if(!e)return;this.portal={guid:null!==selectedPortal&&void 0!==selectedPortal?selectedPortal:"",lat:e.options.data.latE6/1e6,lng:e.options.data.lngE6/1e6,name:e.options.data.title,image:e.options.data.image,address:"",keys:null};let t="<table id='theKey-key-table' style='width: 100%'><tr>\n    <th>Capsule</th>\n    <th>Amount</th>\n  </tr>";const n=h.ownedKeys.find((e=>e.guid===selectedPortal));if(void 0!==n&&n.keys)for(const e of n.keys){if(null!==e.capsule){t+="<tr>\n    <th title='"+e.capsule.name+"'>"+e.capsule.differentiator+"</th>\n    <th><input class='theKey-key-input' data-capsule='"+e.capsule.id+"' type='number' min='0' value='"+e.count+"'></th>\n  </tr>"}null===e.capsule&&(t+="<tr>\n    <th>Inventory</th>\n    <th><input class='theKey-key-input' data-capsule='inventory' type='number' min='0' value='"+e.count+"'></th>\n  </tr>")}t+="</table><input id='theKey-saveBtn' type='button' value='Save'><hr><select id='theKey-newCapsule'></select><input type='button' id='theKey-newCapsuleBtn' value='Add Capsule'>",dialog({id:"the-key-modify-key",title:"Add/Remove Keys: "+this.portal.name,html:t,width:400});const o=$("#theKey-newCapsule");o.empty(),o.append(new Option("In Inventory","inventory")),h.ownedCapsules.forEach((e=>{0===$('.theKey-key-input[data-capsule="'+e.id+'"]').length&&o.append(new Option(e.name,e.id.toString()))})),o.trigger("change")}initEvents(){$("body").on("click","#theKeyAddRemoveBtn",(()=>{h.modifyKeysMenu.openMenu()})),$("body").on("click","#theKey-saveBtn",(()=>{const e=$("#theKey-saveBtn");e.val("Saving...").prop("disabled",!0),setTimeout((()=>{$(".theKey-key-input").each(((e,n)=>{const o=$(n),s=parseInt(o.val());let a=o.data("capsule");"inventory"===a&&(a=null),t.updateSingleKey(this.portal,a,s).catch((e=>{alert(`Failed to update key on capsule ${a}: ${e}`)}))})),h.updateAllUserKeys(),e.val("Save").prop("disabled",!1)}),500)})),$("body").on("click","#theKey-newCapsuleBtn",(()=>{const e=$("#theKey-key-table tr:last"),t=$("#theKey-newCapsule").children("option:selected"),n=t.val();let o,s,a="";if("inventory"!==n){const e=h.ownedCapsules.find((e=>e.id.toString()===n));if(void 0===e)return;o=e.differentiator,a=e.name,s=e.id}else o="Inventory",s="inventory";e.after("<tr>\n    <th title='"+a+"'>"+o+"</th>\n    <th><input class='theKey-key-input' data-capsule='"+s+"' type='number' min='0' value='0'></th>\n  </tr>"),t.remove()}))}}const u={render:e=>{h.myKeysLayerGroup.clearLayers();const t=new L.Icon({iconUrl:"data:image/png;base64,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",iconSize:new L.Point(20,20,!0)});e.forEach((e=>{var n;const o=new L.Marker([e.lat,e.lng],{icon:t,title:e.name});o.on("spiderfiedclick",(()=>u.zoomToPortal(e.guid,new L.LatLng(e.lat,e.lng))));let s="<b>"+e.name+"</b><br>";null===(n=e.keys)||void 0===n||n.forEach((e=>{null!==e.capsule?s+=`${e.count} keys on ${e.capsule.name} capsule<br>`:s+=`${e.count} keys on your inventory<br>`})),o.bindPopup(s).openPopup(),window.registerMarkerForOMS(o),h.myKeysLayerGroup.addLayer(o)}))},zoomToPortal:(e,t)=>{window.selectedPortal!==e?window.renderPortalDetails(e):window.map.panTo(t)}},p=(e,t)=>{const n=h.collectionsLayers.find((e=>e.id===t));if(void 0===n||void 0===n.layer)return;const o=n.layer;o.clearLayers();const s=new L.Icon({iconUrl:"data:image/png;base64,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",iconSize:new L.Point(20,20,!0)});e.forEach((e=>{var t;const n=new L.Marker([e.lat,e.lng],{icon:s,title:e.name});n.on("spiderfiedclick",(()=>u.zoomToPortal(e.guid,new L.LatLng(e.lat,e.lng))));let a="<b>"+e.name+"</b><br>";null===(t=e.keys)||void 0===t||t.forEach((e=>{e.user.agent_name.toLowerCase()!==PLAYER.nickname.toLowerCase()&&(null!==e.capsule?a+=`${e.count} keys on ${e.capsule.user.agent_name}s ${e.capsule.name} capsule<br>`:a+=`${e.count} keys on ${e.user.agent_name}'s inventory<br>`)})),n.bindPopup(a).openPopup(),window.registerMarkerForOMS(n),o.addLayer(n)}))};const h=new class{constructor(){this.mainMenu=new l,this.portalDetailMenu=new c,this.modifyKeysMenu=new d,this.ownedKeys=[],this.sharedKeys=[],this.userCollections=[],this.collectionsLayers=[],this.ownedCapsules=[],this.keyDebug=!1}init(){o(577),this.myKeysLayerGroup=new L.LayerGroup,window.addLayerGroup("[TheKey] - My Keys",this.myKeysLayerGroup,!0),this.mainMenu.init(),this.checkAuthentication(),this.portalDetailMenu.init(),this.modifyKeysMenu.init()}async checkAuthentication(){if(await t.pingAuthentication()){if(!t.isServerCompatible())return void alert("Your TheKey plugin is outdated and is not compatible with the current server version, please update the plugin from the website");this.updateAllLayers()}else this.mainMenu.openMenu()}updateAllLayers(){this.updateAllUserKeys(),this.updateUserCollections(),this.updateUserCapsules(),this.updateAllVisibleKeys()}async updateUserCapsules(){return t.getUserCapsules().then((e=>{this.ownedCapsules=e}))}async updateAllVisibleKeys(){return t.getAllVisibleKeys().then((e=>{this.sharedKeys=e}))}async updateAllUserKeys(){return t.getAllUserKeys().then((e=>{this.ownedKeys=e,u.render(e)}))}async updateUserCollections(){return t.getUserCollections().then((e=>{this.loadCollectionLayers(e)}))}loadCollectionLayers(e){this.userCollections=e;const n=0===this.collectionsLayers.length;for(const o of e){if(n){const e=new L.LayerGroup;window.addLayerGroup("[TheKey] - "+o.name+" collection",e,!0),this.collectionsLayers.push({id:o.id,layer:e})}t.getCollectionKeys(o.id).then((e=>p(e,o.id)))}}};!function(t,n){const o=()=>{window.plugin[n]=t,window.plugin[n].init()};o.info=e,window.bootPlugins||(window.bootPlugins=[]),window.bootPlugins.push(o),window.iitcLoaded&&o()}(h,"TheKey")})()})()}!function(){const e={};if("undefined"!=typeof GM_info&&GM_info&&GM_info.script&&(e.script={version:GM_info.script.version,name:GM_info.script.name,description:GM_info.script.description}),"undefined"!=typeof unsafeWindow||"undefined"==typeof GM_info||"Tampermonkey"!=GM_info.scriptHandler){const t=document.createElement("script");t.appendChild(document.createTextNode("("+wrapper+")("+JSON.stringify(e)+");")),document.head.appendChild(t)}else wrapper(e)}();